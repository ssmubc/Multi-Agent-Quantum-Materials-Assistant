# MCP Setup - Install packages only, no server startup
# MCP server will be started by Streamlit app as subprocess

option_settings:
  aws:elasticbeanstalk:application:environment:
    MCP_SERVER_ENABLED: "true"
    MCP_MATERIALS_SERVER_PATH: "/var/app/current/enhanced_mcp_materials"
    MCP_PYTHON_PATH: "python3.12"
    PYTHONPATH: "/usr/local/lib/python3.12/site-packages:/var/app/current"

container_commands:
  01_install_python312:
    command: |
      echo "=== Installing Python 3.12 ===" | tee -a /var/log/cfn-init-cmd.log
      dnf install -y python3.12 python3.12-pip python3.12-devel gcc 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Python 3.12 install failed but continuing" | tee -a /var/log/cfn-init-cmd.log
      python3.12 --version 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Python 3.12 not available" | tee -a /var/log/cfn-init-cmd.log
      echo "✅ Python 3.12 setup complete" | tee -a /var/log/cfn-init-cmd.log
    ignoreErrors: true
    
  02_install_mcp_packages:
    command: |
      echo "=== Installing MCP packages ===" | tee -a /var/log/cfn-init-cmd.log
      echo "Starting package installation at $(date)" | tee -a /var/log/cfn-init-cmd.log
      
      # Install core packages first
      timeout 300 python3.12 -m pip install --no-warn-script-location mcp pymatgen mp-api plotly matplotlib ase numpy scipy amazon-braket-sdk fastmcp pydantic 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Core package install had issues but continuing" | tee -a /var/log/cfn-init-cmd.log
      
      # Install Strands packages with correct names
      echo "Installing Strands packages..." | tee -a /var/log/cfn-init-cmd.log
      timeout 180 python3.12 -m pip install --no-warn-script-location strands-agents>=1.17.0 strands-agents-tools>=0.2.16 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Strands package install had issues but continuing" | tee -a /var/log/cfn-init-cmd.log
      
      echo "Package installation completed at $(date)" | tee -a /var/log/cfn-init-cmd.log
      
      # Install MCP packages
      echo "Installing enhanced_mcp_materials package..." | tee -a /var/log/cfn-init-cmd.log
      
      # Debug: Show current working directory and list contents
      echo "Current working directory: $(pwd)" | tee -a /var/log/cfn-init-cmd.log
      echo "Contents of current directory:" | tee -a /var/log/cfn-init-cmd.log
      ls -la | tee -a /var/log/cfn-init-cmd.log
      
      # Try multiple possible paths for the enhanced_mcp_materials directory
      MCP_DIR=""
      for dir in "/var/app/ondeck/enhanced_mcp_materials" "/var/app/current/enhanced_mcp_materials" "/opt/python/ondeck/app/enhanced_mcp_materials" "./enhanced_mcp_materials" "enhanced_mcp_materials"; do
        echo "Checking directory: $dir" | tee -a /var/log/cfn-init-cmd.log
        if [ -d "$dir" ]; then
          MCP_DIR="$dir"
          echo "Found enhanced_mcp_materials at: $dir" | tee -a /var/log/cfn-init-cmd.log
          break
        else
          echo "Directory $dir does not exist" | tee -a /var/log/cfn-init-cmd.log
        fi
      done
      
      if [ -n "$MCP_DIR" ]; then
        cd "$MCP_DIR"
        echo "Installing from directory: $(pwd)" | tee -a /var/log/cfn-init-cmd.log
        ls -la | tee -a /var/log/cfn-init-cmd.log
        python3.12 -m pip install -e . 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Enhanced MCP install failed" | tee -a /var/log/cfn-init-cmd.log
      else
        echo "Enhanced MCP directory not found in any expected location" | tee -a /var/log/cfn-init-cmd.log
        echo "Comprehensive search for enhanced_mcp_materials directory..." | tee -a /var/log/cfn-init-cmd.log
        
        # Search in multiple root locations
        for search_root in "/var/app" "/opt/python" "/tmp" "."; do
          echo "Searching in $search_root:" | tee -a /var/log/cfn-init-cmd.log
          find "$search_root" -name "enhanced_mcp_materials" -type d 2>/dev/null | tee -a /var/log/cfn-init-cmd.log || echo "No results in $search_root" | tee -a /var/log/cfn-init-cmd.log
        done
        
        # Also search for any Python files that might indicate the package location
        echo "Searching for server.py files:" | tee -a /var/log/cfn-init-cmd.log
        find /var/app -name "server.py" 2>/dev/null | tee -a /var/log/cfn-init-cmd.log || echo "No server.py files found" | tee -a /var/log/cfn-init-cmd.log
        
        echo "Enhanced MCP directory not found in expected locations" | tee -a /var/log/cfn-init-cmd.log
      fi
      
      # Install Braket MCP package with better path handling
      echo "Installing Braket MCP package..." | tee -a /var/log/cfn-init-cmd.log
      BRAKET_MCP_DIR=""
      
      # Search more comprehensively for Braket MCP
      for search_root in "/var/app/ondeck" "/var/app/current" "/opt/python/ondeck/app" "."; do
        echo "Searching for BraketMCP in $search_root..." | tee -a /var/log/cfn-init-cmd.log
        FOUND_DIR=$(find "$search_root" -name "amazon-braket-mcp-server" -type d 2>/dev/null | head -1)
        if [ -n "$FOUND_DIR" ]; then
          BRAKET_MCP_DIR="$FOUND_DIR"
          echo "Found Braket MCP at: $FOUND_DIR" | tee -a /var/log/cfn-init-cmd.log
          break
        fi
      done
      
      if [ -n "$BRAKET_MCP_DIR" ]; then
        cd "$BRAKET_MCP_DIR"
        echo "Installing Braket MCP from: $(pwd)" | tee -a /var/log/cfn-init-cmd.log
        ls -la | tee -a /var/log/cfn-init-cmd.log
        
        # Check if setup.py or pyproject.toml exists
        if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
          python3.12 -m pip install -e . 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Braket MCP install failed" | tee -a /var/log/cfn-init-cmd.log
        else
          echo "No setup.py or pyproject.toml found, trying direct install" | tee -a /var/log/cfn-init-cmd.log
          # Try to install dependencies and copy files
          python3.12 -m pip install amazon-braket-sdk qiskit-braket-provider fastmcp 2>&1 | tee -a /var/log/cfn-init-cmd.log
          # Copy the package to site-packages
          cp -r . "/usr/local/lib/python3.12/site-packages/amazon_braket_mcp_server" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Manual copy failed" | tee -a /var/log/cfn-init-cmd.log
        fi
      else
        echo "Braket MCP directory not found, installing fallback dependencies" | tee -a /var/log/cfn-init-cmd.log
        python3.12 -m pip install amazon-braket-sdk qiskit-braket-provider fastmcp 2>&1 | tee -a /var/log/cfn-init-cmd.log
      fi
      
      ls -la /usr/local/lib/python3.12/site-packages/ 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Package directory not found" | tee -a /var/log/cfn-init-cmd.log
      echo "✅ MCP packages installation complete" | tee -a /var/log/cfn-init-cmd.log
    ignoreErrors: true
    
  03_test_mcp_server:
    command: |
      echo "=== Testing MCP Server ===" | tee -a /var/log/cfn-init-cmd.log
      export PYTHONPATH="/usr/local/lib/python3.12/site-packages:/var/app/current:$PYTHONPATH"
      
      # Test if package was installed correctly
      echo "Testing enhanced_mcp_materials import..." | tee -a /var/log/cfn-init-cmd.log
      python3.12 -c "import enhanced_mcp_materials; print('✅ Enhanced MCP import OK')" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Enhanced MCP import failed" | tee -a /var/log/cfn-init-cmd.log
      
      # Show installed packages for debugging
      echo "Checking installed packages..." | tee -a /var/log/cfn-init-cmd.log
      python3.12 -c "import pkg_resources; [print(f'{d.project_name}: {d.version}') for d in pkg_resources.working_set if 'enhanced' in d.project_name.lower() or 'mcp' in d.project_name.lower()]" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Package check failed" | tee -a /var/log/cfn-init-cmd.log
      
      # Test server imports if base packages work
      if python3.12 -c "import enhanced_mcp_materials" 2>/dev/null; then
        echo "Testing Enhanced MCP server import..." | tee -a /var/log/cfn-init-cmd.log
        python3.12 -c "import enhanced_mcp_materials.server; print('✅ Enhanced MCP server import OK')" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "Enhanced MCP server import failed" | tee -a /var/log/cfn-init-cmd.log
      fi
      
      # Test Braket MCP import with multiple paths
      echo "Testing Braket MCP import..." | tee -a /var/log/cfn-init-cmd.log
      
      # Test primary import path
      if python3.12 -c "from amazon_braket_mcp_server.braket_service import BraketService; print('✅ Braket MCP import OK (primary)')" 2>/dev/null; then
        echo "✅ Braket MCP primary import successful" | tee -a /var/log/cfn-init-cmd.log
      elif python3.12 -c "from awslabs.amazon_braket_mcp_server.braket_service import BraketService; print('✅ Braket MCP import OK (awslabs)')" 2>/dev/null; then
        echo "✅ Braket MCP awslabs import successful" | tee -a /var/log/cfn-init-cmd.log
      else
        echo "⚠️ Braket MCP import failed, but fallback will be used" | tee -a /var/log/cfn-init-cmd.log
        # Test if basic Braket SDK works
        python3.12 -c "from braket.circuits import Circuit; print('✅ Basic Braket SDK available')" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "❌ Braket SDK also failed" | tee -a /var/log/cfn-init-cmd.log
      fi
      
      # Test Strands imports
      echo "Testing Strands imports..." | tee -a /var/log/cfn-init-cmd.log
      python3.12 -c "from strands_agents import Agent; print('✅ Strands agents import OK')" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "❌ Strands agents import failed" | tee -a /var/log/cfn-init-cmd.log
      python3.12 -c "from strands_agents_tools import use_aws; print('✅ Strands tools import OK')" 2>&1 | tee -a /var/log/cfn-init-cmd.log || echo "❌ Strands tools import failed" | tee -a /var/log/cfn-init-cmd.log
      
      echo "✅ MCP server test complete" | tee -a /var/log/cfn-init-cmd.log
    ignoreErrors: true

files:
  "/etc/profile.d/mcp-python-path.sh":
    mode: "000644"
    owner: root
    group: root
    content: |
      export PYTHONPATH="/usr/local/lib/python3.12/site-packages:/var/app/current:$PYTHONPATH"